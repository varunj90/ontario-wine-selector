generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                 String              @id @default(cuid())
  email              String              @unique
  displayName        String?
  onboardingComplete Boolean             @default(false)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  tastings           UserTasting[]
  events             UserEvent[]
  recommendationLogs RecommendationLog[]
}

model Wine {
  id              String             @id @default(cuid())
  lcboProductId   String?            @unique
  name            String
  producer        String
  type            String
  varietal        String
  country         String
  subRegion       String
  fullRegionLabel String
  lcboUrl         String?
  vivinoUrl       String?
  volumeMl        Int?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  marketData      WineMarketData[]
  qualitySignals  WineQualitySignal[]
  tastings        UserTasting[]
  events          UserEvent[]

  @@index([name])
  @@index([type, varietal, country, subRegion])
  @@unique([name, producer, varietal, country, subRegion], map: "wine_identity_unique")
}

model Store {
  id              String         @id @default(cuid())
  lcboStoreCode   String?        @unique
  displayName     String
  city            String?
  province        String?        @default("ON")
  postalPrefix    String?
  latitude        Float?
  longitude       Float?
  isActive        Boolean        @default(true)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  marketData      WineMarketData[]
}

model WineMarketData {
  id                String   @id @default(cuid())
  wineId            String
  storeId           String
  listedPriceCents  Int
  inventoryQuantity Int?
  inStock           Boolean  @default(true)
  sourceUpdatedAt   DateTime
  createdAt         DateTime @default(now())
  wine              Wine     @relation(fields: [wineId], references: [id], onDelete: Cascade)
  store             Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@index([wineId, storeId])
  @@index([sourceUpdatedAt])
}

model WineQualitySignal {
  id              String   @id @default(cuid())
  wineId          String
  source          String
  rating          Float
  ratingCount     Int
  confidenceScore Float
  fetchedAt       DateTime
  createdAt       DateTime @default(now())
  wine            Wine     @relation(fields: [wineId], references: [id], onDelete: Cascade)

  @@index([wineId, source])
  @@index([rating, ratingCount])
}

model UserEvent {
  id        String   @id @default(cuid())
  userId    String
  wineId    String?
  eventName String
  payload   Json?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  wine      Wine?    @relation(fields: [wineId], references: [id], onDelete: SetNull)

  @@index([userId, createdAt])
  @@index([eventName])
}

model UserTasting {
  id           String   @id @default(cuid())
  userId       String
  wineId       String
  rating       Float?
  note         String?
  contextTag   String?
  consumedAt   DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  wine         Wine     @relation(fields: [wineId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([wineId])
}

model RecommendationLog {
  id               String   @id @default(cuid())
  userId           String?
  queryHash        String
  recommendationIds Json
  rankingMeta      Json?
  createdAt        DateTime @default(now())
  user             User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([queryHash, createdAt])
}

model IngestionRun {
  id            String   @id @default(cuid())
  source        String
  status        String
  startedAt     DateTime @default(now())
  completedAt   DateTime?
  itemsRead     Int      @default(0)
  itemsWritten  Int      @default(0)
  errorMessage  String?
  metadata      Json?
  deadLetters   IngestionDeadLetter[]

  @@index([source, startedAt])
  @@index([status, startedAt])
}

model IngestionDeadLetter {
  id             String        @id @default(cuid())
  source         String
  stage          String
  reason         String
  externalId     String?
  payload        Json
  receivedAt     DateTime      @default(now())
  ingestionRunId String?
  ingestionRun   IngestionRun? @relation(fields: [ingestionRunId], references: [id], onDelete: SetNull)

  @@index([source, receivedAt])
  @@index([ingestionRunId])
}
